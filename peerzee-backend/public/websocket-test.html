<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WebSocket Test - Peerzee</title>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, sans-serif; background: #f5f5f5; padding: 20px; }
    .container { max-width: 1000px; margin: 0 auto; }
    h1 { margin-bottom: 20px; color: #333; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .card { background: white; border-radius: 8px; padding: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .card h3 { margin-bottom: 12px; font-size: 14px; color: #666; text-transform: uppercase; }
    input, textarea, button { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 10px; font-size: 14px; }
    button { background: #333; color: white; cursor: pointer; border: none; }
    button:hover { background: #555; }
    button:disabled { background: #999; }
    .btn-success { background: #22c55e; }
    .btn-danger { background: #ef4444; }
    #status { padding: 8px 12px; border-radius: 4px; font-size: 12px; margin-bottom: 10px; }
    .connected { background: #dcfce7; color: #166534; }
    .disconnected { background: #fee2e2; color: #991b1b; }
    #log { height: 300px; overflow-y: auto; background: #1e1e1e; color: #d4d4d4; padding: 12px; border-radius: 6px; font-family: monospace; font-size: 12px; }
    .log-entry { margin-bottom: 4px; }
    .log-send { color: #4ade80; }
    .log-receive { color: #60a5fa; }
    .log-error { color: #f87171; }
    .log-info { color: #fbbf24; }
    .section { margin-bottom: 20px; }
    label { font-size: 12px; color: #666; display: block; margin-bottom: 4px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ðŸ”Œ WebSocket Test - Peerzee</h1>
    
    <div class="grid">
      <!-- Left Column: Connection & Actions -->
      <div>
        <!-- Connection -->
        <div class="card section">
          <h3>1. Connection</h3>
          <div id="status" class="disconnected">Disconnected</div>
          <label>JWT Token</label>
          <textarea id="token" rows="3" placeholder="Paste your JWT token here..."></textarea>
          <button id="btnConnect" class="btn-success" onclick="connect()">Connect</button>
          <button id="btnDisconnect" class="btn-danger" onclick="disconnect()" disabled>Disconnect</button>
        </div>

        <!-- Create Conversation -->
        <div class="card section">
          <h3>2. Create Conversation</h3>
          <label>Other User ID</label>
          <input type="text" id="otherUserId" placeholder="UUID of other user">
          <label>Type</label>
          <input type="text" id="convType" value="private" placeholder="private or group">
          <button onclick="createConversation()">Create Conversation</button>
        </div>

        <!-- Join Conversation -->
        <div class="card section">
          <h3>3. Join Conversation</h3>
          <label>Conversation ID</label>
          <input type="text" id="joinConvId" placeholder="Conversation UUID">
          <button onclick="joinConversation()">Join Conversation</button>
        </div>

        <!-- Send Message -->
        <div class="card section">
          <h3>4. Send Message</h3>
          <label>Conversation ID</label>
          <input type="text" id="msgConvId" placeholder="Conversation UUID">
          <label>Message</label>
          <input type="text" id="msgBody" placeholder="Your message...">
          <button onclick="sendMessage()">Send Message</button>
        </div>

        <!-- Get Messages -->
        <div class="card section">
          <h3>5. Get Messages</h3>
          <label>Conversation ID</label>
          <input type="text" id="getConvId" placeholder="Conversation UUID">
          <button onclick="getMessages()">Get Messages</button>
        </div>
      </div>

      <!-- Right Column: Log -->
      <div>
        <div class="card">
          <h3>Event Log</h3>
          <button onclick="clearLog()" style="width: auto; padding: 6px 12px; margin-bottom: 10px;">Clear Log</button>
          <div id="log"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let socket = null;

    function log(message, type = 'info') {
      const logDiv = document.getElementById('log');
      const time = new Date().toLocaleTimeString();
      const entry = document.createElement('div');
      entry.className = `log-entry log-${type}`;
      entry.innerHTML = `[${time}] ${message}`;
      logDiv.appendChild(entry);
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    function clearLog() {
      document.getElementById('log').innerHTML = '';
    }

    function updateStatus(connected) {
      const status = document.getElementById('status');
      status.textContent = connected ? 'Connected âœ“' : 'Disconnected';
      status.className = connected ? 'connected' : 'disconnected';
      document.getElementById('btnConnect').disabled = connected;
      document.getElementById('btnDisconnect').disabled = !connected;
    }

    function connect() {
      const token = document.getElementById('token').value.trim();
      if (!token) {
        log('Please enter a token!', 'error');
        return;
      }

      log('Connecting to ws://localhost:9000...', 'info');
      
      socket = io('http://localhost:9000', {
        auth: { token: token },
        transports: ['websocket']
      });

      socket.on('connect', () => {
        log('Connected! Socket ID: ' + socket.id, 'receive');
        updateStatus(true);
      });

      socket.on('disconnect', (reason) => {
        log('Disconnected: ' + reason, 'error');
        updateStatus(false);
      });

      socket.on('connect_error', (error) => {
        log('Connection error: ' + error.message, 'error');
        updateStatus(false);
      });

      // Listen for new messages
      socket.on('message:new', (data) => {
        log('ðŸ“© message:new: ' + JSON.stringify(data, null, 2), 'receive');
      });

      // Listen for user typing
      socket.on('user:typing', (data) => {
        log('âœï¸ user:typing: ' + JSON.stringify(data), 'receive');
      });
    }

    function disconnect() {
      if (socket) {
        socket.disconnect();
        socket = null;
        log('Disconnected manually', 'info');
        updateStatus(false);
      }
    }

    function createConversation() {
      if (!socket) { log('Not connected!', 'error'); return; }
      
      const otherUserId = document.getElementById('otherUserId').value.trim();
      const type = document.getElementById('convType').value.trim();
      
      const payload = {
        type: type,
        participantUserIds: otherUserId ? [otherUserId] : []
      };
      
      log('â†’ conversation:create: ' + JSON.stringify(payload), 'send');
      
      socket.emit('conversation:create', payload, (response) => {
        log('â† Response: ' + JSON.stringify(response, null, 2), 'receive');
        if (response?.conversationId) {
          document.getElementById('joinConvId').value = response.conversationId;
          document.getElementById('msgConvId').value = response.conversationId;
          document.getElementById('getConvId').value = response.conversationId;
        }
      });
    }

    function joinConversation() {
      if (!socket) { log('Not connected!', 'error'); return; }
      
      const convId = document.getElementById('joinConvId').value.trim();
      if (!convId) { log('Enter conversation ID!', 'error'); return; }
      
      const payload = { conversation_id: convId };
      log('â†’ conversation:join: ' + JSON.stringify(payload), 'send');
      
      socket.emit('conversation:join', payload, (response) => {
        log('â† Response: ' + JSON.stringify(response, null, 2), 'receive');
      });
    }

    function sendMessage() {
      if (!socket) { log('Not connected!', 'error'); return; }
      
      const convId = document.getElementById('msgConvId').value.trim();
      const body = document.getElementById('msgBody').value.trim();
      
      if (!convId || !body) { log('Enter conversation ID and message!', 'error'); return; }
      
      const payload = { conversation_id: convId, body: body };
      log('â†’ conversation:send: ' + JSON.stringify(payload), 'send');
      
      socket.emit('conversation:send', payload, (response) => {
        log('â† Response: ' + JSON.stringify(response, null, 2), 'receive');
      });
      
      document.getElementById('msgBody').value = '';
    }

    function getMessages() {
      if (!socket) { log('Not connected!', 'error'); return; }
      
      const convId = document.getElementById('getConvId').value.trim();
      if (!convId) { log('Enter conversation ID!', 'error'); return; }
      
      const payload = { conversation_id: convId };
      log('â†’ conversation:messages: ' + JSON.stringify(payload), 'send');
      
      socket.emit('conversation:messages', payload, (response) => {
        log('â† Response: ' + JSON.stringify(response, null, 2), 'receive');
      });
    }

    // Enter key to send message
    document.getElementById('msgBody').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendMessage();
    });
  </script>
</body>
</html>
